<html><h3><strong>Problem</strong></h3>

<p>Whenever an artifact is assigned to a CI, there will be an entry created in 'cfg_at_assignment_ci' table which maps CI id with assignment id. When we try to delete all assignments whose CI is already deleted, for a few assignments somehow that mapping entry is missing and deletion of such assignments fails as it considers that there is no such entry in the DB. As a result events with ‘Deleting assignments failed during auto assignment. ‘ are getting logged.</p>

<h3><strong>Work around </strong></h3>

<p>As we saw above, the deletion fails because of missing entry in mapping table, so, as a work around we will fetch all problematic assignments from logs and get its assignment id and CI id from Database and add the mapping entry into 'cfg_at_assignment_ci' table so that deletion of unused assignments go smooth.</p>

<h3><strong>Steps to achieve work around (Queries are Oracle DB Compatible)</strong></h3>

<p>1) Check if you got event with below mentioned error message, if the message is not same then this work around would not help you.<br>
‘Deleting assignments failed during auto assignment.‘</p>

<p>OR</p>

<p>If you are getting below mentioned error message on selecting an assignment then that qualifies for the workaround.</p>

<p>No &lt;artifact&gt; with id: "&lt;assignment_type&gt;:&lt;artifact version id&gt;:&lt;ci id&gt;" found.<br>
Eg : No TemplateAssignment with id: "TemplateAssignment:c610e770-4812-b49d-c18d-5b7d35e951d7:40f8e0cd6c1c03739632cec8ad9011c5" found.</p>

<p>2) Look for log messages starting with 'caught unexpected exception when deleting assignment' in &lt;OBM&gt;\log\jboss\opr-configserver.log.* of DPS. Also make sure only those assignments for which you got the failing event&nbsp; / got UI error message&nbsp; only those assignment's logs are to be considered. The logs will have a string like below.</p>

<p>ManagementTemplateAssignment:84413803-d4aa-4470-8c3b-571987929bbd:decafc0ffeefacedbabef00ddeadbeef</p>

<p>The String has 3 parts :<br>
ManagementTemplateAssignment - Type of assignment(ManagementTemplateAssignment/AspectAssignment/TemplateAssignment)<br>
84413803-d4aa-4470-8c3b-571987929bbd - artifact version id<br>
decafc0ffeefacedbabef00ddeadbeef - ci id</p>

<p>Eg:<br>
ERROR AssignmentService.call(?) - caught unexpected exception when deleting assignment ManagementTemplateAssignment:84413803-d4aa-4470-8c3b-571987929bbd:decafc0ffeefacedbabef00ddeadbeef</p>

<p><br>
3) Prepare SQL queries (refer below syntax) for all assignment IDs which are captured in step2. These queries are to be run on ‘event’ schema.</p>

<p><strong>select ci_id,direct_assignment_id from &lt;schema&gt;.cfg_at_assignment_ci where direct_assignment_id = (SELECT id FROM cfg_directassignment where ci_id='&lt;ci id&gt;' and version_object_id=’&lt;artifact version id&gt;') and ci_id != '&lt;ci id&gt;')</strong></p>

<p>Execute the queries on ‘event’ DB schema.</p>

<p>And for whichever query we get the output (ci_id , direct_assignment_id) only those assignment details are to be considered for next step. Here we just double check that there is a missing entry in mapping table and fetch its direct_assignment_id.</p>

<p>4) Insert missing records into cfg_at_assignment_ci table for entries received in step3.</p>

<p>Insert query will look like this:<br>
<strong>INSERT INTO &lt;schema&gt;.cfg_at_assignment_ci ("id", "ci_id", "direct_assignment_id") values (‘&lt;id&gt;','&lt;ci id&gt;','&lt;artefact version id&gt;')</strong></p>

<p>ci_id and direct_assignment_id will be taken from step3's query output.<br>
id needs to be generated, please generate new UUID and provide it to the query.</p>

<p>You will have as many insert queries as output records from step3. Run all those insert queries on 'event' DB schema.<br>
Perform ‘commit’.</p>

<p>Now after these steps mapping entries will be created in cfg_at_assignment_ci for all problematic assignments and as a result all the unused assignments can be deleted.</p>

<h3><strong>Validation to check if work around works</strong></h3>

<p>Every 12 hours (by default) Topo scan will run which will delete all assignments whose CI's are already deleted. That topo scan should go smooth without any errors. You also can change the Infrastructure setting ‘ Time interval to scan for changed topology ’ to 5 mins to cross check the fix immediately. After you confirm the fix works please revert value back to its previous value.</p>
</html>