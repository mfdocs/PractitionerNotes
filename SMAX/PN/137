





<!--StartFragment-->

<div style="direction:ltr;border-width:100%">

<div style="direction:ltr;margin-top:0in;margin-left:0in;width:7.7715in">

<div style="direction:ltr;margin-top:0in;margin-left:0in;width:7.7715in">

<p style="margin:0in;font-family:Calibri;font-size:11.0pt">After SMAX
installed, for some reason like NFS server maintenance, NFS stability issue,
performance issue or other reasons,&nbsp;
there is a requirement to switch NFS from one server to another server. </p>

<p style="margin:0in;font-family:Calibri;font-size:11.0pt">Please follow below
document to finish operations.</p>

<p style="margin:0in;font-family:Calibri;font-size:11.0pt"><span style="font-weight:bold">Note: during switch NFS, SMAX downtime occurs,
schedule maintenance window to do this.</span></p>

<p style="margin:0in;font-family:Calibri;font-size:11.0pt">&nbsp;</p>

<h3 style="margin:0in;font-family:Calibri;font-size:11.0pt">Part I: CDF</h3>

<p style="margin:0in;font-family:Calibri;font-size:11.0pt">Following below
document to change NFS server for CDF</p>

<p style="margin:0in;font-family:Calibri;font-size:11.0pt"><a href="https://docs.microfocus.com/itom/SMAX:2019.11/changePersistentVolumes">https://docs.microfocus.com/itom/SMAX:2019.11/changePersistentVolumes</a><span style="background-color: transparent; font-size: 11pt; letter-spacing: 0.2px;">&nbsp;</span></p>

<h3 style="margin:0in;font-family:Calibri;font-size:11.0pt">Part II: SMAX</h3>

<ol><li><span style="font-family: Calibri; font-size: 11pt; background-color: transparent;">Stop SMAX first.</span></li>
<li>Run below script on
one of master node.</li><li>After checking all PV is set up correctly, Refer to document (<a href="https://docs.microfocus.com/itom/SMAX:2019.11/RestartSMASuite" style="font-size: 11pt; letter-spacing: 0.2px; background-color: transparent;"><span style="font-family: Calibri; font-size: 11pt;">https://docs.microfocus.com/itom/SMAX:2019.11/RestartSMASuite</span></a><span style="font-family: Calibri; letter-spacing: 0.2px; background-color: transparent; font-size: 11pt;">) to restart Kubernetes Cluster.</span></li></ol><div>The scripts will do below task:<font face="Calibri"><span style="font-size: 14.6667px; letter-spacing: 0.2px;"><br></span></font></div></div></div></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div style="direction:ltr;border-width:100%"><div style="direction:ltr;margin-top:0in;margin-left:0in;width:7.7715in"><div style="direction:ltr;margin-top:0in;margin-left:0in;width:7.7715in"><ul><li><span style="background-color: transparent; font-family: Calibri; font-size: 11pt;">Backup current PV for
     Kubernetes cluster under /tmp/</span><span style="background-color: transparent; font-style: italic; font-family: Calibri; font-size: 11pt;">Persistentvolume/</span><span style="background-color: transparent; font-family: Calibri; font-size: 11pt;">pv/old folder</span></li><li><span style="background-color: transparent; font-family: Calibri; font-size: 11pt;">Create new PV yaml file in
     the new folder /tmp/</span><span style="background-color: transparent; font-style: italic; font-family: Calibri; font-size: 11pt;">Persistentvolume/</span><span style="background-color: transparent; font-family: Calibri; font-size: 11pt;">pv/new</span></li><li><span style="background-color: transparent; font-family: Calibri; font-size: 11pt;">Backup current PVC for
     Kubernetes cluster under /tmp/</span><span style="background-color: transparent; font-style: italic; font-family: Calibri; font-size: 11pt;">Persistentvolume/</span><span style="background-color: transparent; font-family: Calibri; font-size: 11pt;">pvc/old folder</span></li><li><span style="background-color: transparent; font-family: Calibri; font-size: 11pt;">Create new PVC yaml file in
     the new folder /tmp/</span><span style="background-color: transparent; font-style: italic; font-family: Calibri; font-size: 11pt;">Persistentvolume/</span><span style="background-color: transparent; font-family: Calibri; font-size: 11pt;">pvc/new</span></li><li><span style="background-color: transparent; font-family: Calibri; font-size: 11pt;">Create new PVC with updated
     PVC yaml.</span></li><li><span style="background-color: transparent; font-family: Calibri; font-size: 11pt;">Create new PV with updated PV
     yaml</span></li></ul></div></div></div></blockquote><i><font face="Calibri" style="background-color: transparent;"><span style="font-size: 14.6667px;">################ Scripts Begin&nbsp;</span></font><span style="background-color: transparent; font-family: Calibri; font-size: 14.6667px;">################</span><span style="background-color: transparent; font-family: Calibri; font-size: 14.6667px;">&nbsp;</span></i><br><div style="direction:ltr;border-width:100%"><div style="direction:ltr;margin-top:0in;margin-left:0in;width:7.7715in"><div style="direction:ltr;margin-top:0in;margin-left:0in;width:7.7715in">

<p style="margin: 0in;"><font face="Calibri"><span style="font-size: 11pt;">&nbsp;</span></font><span style="background-color: transparent;"><font face="Calibri"><i>#!/bin/bash</i></font></span></p><p style="margin: 0in;"><font face="Calibri"><i># This script is used to change PV IP address (keep path) for an installed SMAX&nbsp;</i></font></p><p style="margin: 0in;"><font face="Calibri"><i># This script will:&nbsp;</i></font></p><p style="margin: 0in;"><font face="Calibri"><i># * Backup current PV for Kubernetes cluster under /tmp/Persistentvolume/pv/old folder</i></font></p><p style="margin: 0in;"><font face="Calibri"><i># * Create new PV yaml file in the new folder /tmp/Persistentvolume/pv/new</i></font></p><p style="margin: 0in;"><font face="Calibri"><i># * Backup current PVC for Kubernetes cluster under /tmp/Persistentvolume/pvc/old folder</i></font></p><p style="margin: 0in;"><font face="Calibri"><i># * Create new PVC yaml file in the new folder /tmp/Persistentvolume/pvc/new</i></font></p><p style="margin: 0in;"><font face="Calibri"><i># * Create new PVC with updated PVC yaml.</i></font></p><p style="margin: 0in;"><font face="Calibri"><i># * Create new PV with updated PV yaml.</i></font></p><p style="margin: 0in;"><font face="Calibri"><i><br></i></font></p><p style="margin: 0in;"><font face="Calibri"><i>#set -x</i></font></p><p style="margin: 0in;"><font face="Calibri"><i><br></i></font></p><p style="margin: 0in;"><font face="Calibri"><i>if [ $# -lt 2 ]; then</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; echo "Usage: $0 &lt;old_pv_path&gt; &lt;new_pv_path&gt;"</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; exit 1</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>fi</i></font></p><p style="margin: 0in;"><font face="Calibri"><i><br></i></font></p><p style="margin: 0in;"><font face="Calibri"><i>oldpv=$1</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>newpv=$2</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>file_date=`date "+%Y%m%d%H%M%S"`</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>ns=`kubectl get namespace |grep itsma | cut -f1 -d " "`</i></font></p><p style="margin: 0in;"><font face="Calibri"><i><br></i></font></p><p style="margin: 0in;"><font face="Calibri"><i>if [ -d /tmp/Persistentvolume/pv ]; then</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; mv /tmp/Persistentvolume/pv /tmp/Persistentvolume/pv.bak.${file_date}</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>fi</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>if [ -d /tmp/Persistentvolume/pvc ]; then</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; mv /tmp/Persistentvolume/pvc /tmp/Persistentvolume/pvc.bak.${file_date}</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>fi</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>mkdir -p /tmp/Persistentvolume/pvc/old</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>mkdir -p /tmp/Persistentvolume/pvc/new</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>mkdir -p /tmp/Persistentvolume/pv/old</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>mkdir -p /tmp/Persistentvolume/pv/new</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>change_pv() {</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; file=$1</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/annotations/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/kubernetes.io/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/creatiofileTimestamp/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/deletionGrfilecePeriodSeconds/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/finalizers/d'file$file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/selfLink/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/resourceVersion/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/uid/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i'/status/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/fileessage/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>}</i></font></p><p style="margin: 0in;"><font face="Calibri"><i><br></i></font></p><p style="margin: 0in;"><font face="Calibri"><i>change_pvc() {</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; file=$1</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/annotations/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/kubernetes.io/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/creationTimestamp/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/deletionGracePeriodSeconds/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i -e 's/finalizers:/namespace: itsma1/g' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/selfLink/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/resourceVersion/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/uid/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/status/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; sed -i '/message/d' $file</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>}</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>save_pvc() {</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; for i in `kubectl get pvc -n $ns | grep -v NAME | grep $ns | cut -f1 -d " "`</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; do</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; echo "save pvc: $i"</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; kubectl get pvc $i -n $ns -o yaml --export &gt; /tmp/Persistentvolume/pvc/old/${i}_pvc.yaml</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; kubectl get pvc $i -n $ns -o yaml --export&gt; /tmp/Persistentvolume/pvc/new/${i}_pvc.yaml</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; change_pvc /tmp/Persistentvolume/pvc/new/${i}_pvc.yaml</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; done</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>}</i></font></p><p style="margin: 0in;"><font face="Calibri"><i><br></i></font></p><p style="margin: 0in;"><font face="Calibri"><i>delete_pvc() {</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; for i in `kubectl get pvc -n $ns | grep -v NAME | grep $ns | cut -f1 -d " "`</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; do</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; echo "delete pvc: $i"</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; kubectl patch pvc $i -n $ns -p '{"metadata":{"finalizers": []}}' --type=merge</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; kubectl delete pvc $i -n $ns --force --grace-period=0</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; done</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>}</i></font></p><p style="margin: 0in;"><font face="Calibri"><i><br></i></font></p><p style="margin: 0in;"><font face="Calibri"><i>save_pv() {</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; for i in `kubectl get pv | grep -v NAME |&nbsp; grep $ns | cut -f1 -d " "`</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; do</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; echo "save pv: $i"</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; kubectl get pv $i -o yaml --export &gt; /tmp/Persistentvolume/pv/old/${i}_pv.yaml</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; kubectl get pv $i -o yaml --export| sed 's/'${oldpv}'/'${newpv}'/g' &gt; /tmp/Persistentvolume/pv/new/${i}_pv.yaml</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; change_pvc /tmp/Persistentvolume/pv/new/${i}_pv.yaml</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; done</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>}</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>delete_pv() {</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; for i in `kubectl get pv | grep -v NAME |&nbsp; grep $ns| cut -f1 -d " "`</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; do</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; echo "delete pv: $i"</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; kubectl delete pv $i --force --grace-period=0</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; done</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>}</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>create_pv() {</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; for i in `find /tmp/Persistentvolume/pv/new -type f`</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; do</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; echo "create pv： $i"</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; kubectl create -f $i</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; done</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>}</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>create_pvc() {</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; for i in `find /tmp/Persistentvolume/pvc/new -type f`</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; do</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; echo "create pvc： $i"</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; &nbsp; kubectl create -f $i</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; done</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>}</i></font></p><p style="margin: 0in;"><font face="Calibri"><i><br></i></font></p><p style="margin: 0in;"><font face="Calibri"><i>function check_pod(){</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>pod_name=$1</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>echo checking pod status for ${pod_name}</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>number=`kubectl get pods -n $ns -o wide |grep ${pod_name} | awk -F " *|/" '($3!=$4 || $5!="Running") &amp;&amp; $5!="Completed" {print $0}' |wc -l`</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>if [ $number -gt 0 ]; then</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; echo "Error: pod ($pod_name) is running, please make sure SMAX($ns) is stopped first."</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>&nbsp; exit 1</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>fi</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>}</i></font></p><p style="margin: 0in;"><font face="Calibri"><i><br></i></font></p><p style="margin: 0in;"><font face="Calibri"><i>check_pod rabbitmq</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>check_pod platform</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>check_pod idm</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>save_pv</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>save_pvc</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>delete_pvc</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>delete_pv</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>create_pv</i></font></p><p style="margin: 0in;"><font face="Calibri"><i>create_pvc</i></font></p>

<p style="margin:0in;font-family:Calibri;font-size:11.0pt"><i><font face="Calibri" style="background-color: transparent;"><span style="font-size: 14.6667px;">################ Scripts End&nbsp;</span></font><span style="background-color: transparent; font-size: 14.6667px;">################</span><span style="background-color: transparent; font-size: 14.6667px;">&nbsp;</span></i></p>

</div>

</div>

</div>

<!--EndFragment-->