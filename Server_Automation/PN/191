<p class="line874" style="color: rgb(0, 0, 0); letter-spacing: normal; font-family: sans-serif; font-size: 16px;">The event cache service provide events that describe the last change made to persistent objects. Client programs can use this mechanism to trigger various actions such as updating a client side cache of value objects.<span class="anchor" id="line-1237"></span><span class="anchor" id="line-1238"></span></p><p class="line867" style="color: rgb(0, 0, 0); letter-spacing: normal; font-family: sans-serif; font-size: 16px;"></p><h2 id="Monitoring_object_update_events" style="color: rgb(0, 0, 0); letter-spacing: normal; text-transform: none; font-family: sans-serif;">Monitoring object update events</h2><span class="anchor" id="line-1239" style="color: rgb(0, 0, 0); font-family: sans-serif;"></span><span class="anchor" id="line-1240" style="color: rgb(0, 0, 0); font-family: sans-serif;"></span><p class="line874" style="color: rgb(0, 0, 0); letter-spacing: normal; font-family: sans-serif; font-size: 16px;">Monitor the event cache and display when something happens to an object.<span class="anchor" id="line-1241"></span><span class="anchor" id="line-1242"></span><span class="anchor" id="line-1243"></span><span class="anchor" id="line-1244"></span><span class="anchor" id="line-1245"></span><span class="anchor" id="line-1246"></span><span class="anchor" id="line-1247"></span><span class="anchor" id="line-1248"></span><span class="anchor" id="line-1249"></span><span class="anchor" id="line-1250"></span><span class="anchor" id="line-1251"></span><span class="anchor" id="line-1252"></span><span class="anchor" id="line-1253"></span><span class="anchor" id="line-1254"></span><span class="anchor" id="line-1255"></span><span class="anchor" id="line-1256"></span><span class="anchor" id="line-1257"></span><span class="anchor" id="line-1258"></span><span class="anchor" id="line-1259"></span><span class="anchor" id="line-1260"></span><span class="anchor" id="line-1261"></span><span class="anchor" id="line-1262"></span><span class="anchor" id="line-1263"></span><span class="anchor" id="line-1264"></span><span class="anchor" id="line-1265"></span><span class="anchor" id="line-1-165"></span></p><div class="highlight python" style="color: rgb(0, 0, 0); font-family: sans-serif;"><div class="codearea" dir="ltr" lang="en" style="margin: 0.5em 0px; padding: 0px; border: 1pt solid rgb(174, 189, 204); background-color: rgb(243, 245, 247);"><pre dir="ltr" id="CA-859e22f195d669895507a4df15e402fa86e1c34d" lang="en" style="border-width: initial; border-style: none; background-color: rgb(243, 245, 247); padding: 10pt; font-family: courier, monospace; white-space: pre-wrap; overflow-wrap: break-word;"><span class="line"><span class="Comment" style="color: rgb(0, 128, 0);">#!/opt/opsware/bin/python</span></span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_2"></span><span class="anchor" id="line-2-87"></span><span class="ResWord" style="color: rgb(160, 0, 0);">import</span> <span class="ID">time</span></span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_3"></span><span class="anchor" id="line-3-72"></span><span class="ResWord" style="color: rgb(160, 0, 0);">from</span> <span class="ID">pytwist</span> <span class="ResWord" style="color: rgb(160, 0, 0);">import</span> <span class="ID">twistserver</span></span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_4"></span><span class="anchor" id="line-4-58"></span><span class="ResWord" style="color: rgb(160, 0, 0);">from</span> <span class="ID">pytwist.com.opsware.cache</span> <span class="ResWord" style="color: rgb(160, 0, 0);">import</span> <span class="ID">Event</span></span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_5"></span><span class="anchor" id="line-5-54"></span></span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_6"></span><span class="anchor" id="line-6-46"></span><span class="ID">ts</span> = <span class="ID">twistserver</span>.<span class="ID">TwistServer</span>()</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_7"></span><span class="anchor" id="line-7-38"></span><span class="ID">ts</span>.<span class="ID">authenticate</span>(<span class="String" style="color: rgb(0, 64, 128);">"</span><span class="String" style="color: rgb(0, 64, 128);">user</span><span class="String" style="color: rgb(0, 64, 128);">"</span>,<span class="String" style="color: rgb(0, 64, 128);">"</span><span class="String" style="color: rgb(0, 64, 128);">password</span><span class="String" style="color: rgb(0, 64, 128);">"</span>)</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_8"></span><span class="anchor" id="line-8-35"></span></span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_9"></span><span class="anchor" id="line-9-30"></span><span class="ID">actionMap</span> = {<span class="ID">Event</span>.<span class="ID">CREATED</span>:<span class="String" style="color: rgb(0, 64, 128);">'</span><span class="String" style="color: rgb(0, 64, 128);">Created</span><span class="String" style="color: rgb(0, 64, 128);">'</span>,</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_10"></span><span class="anchor" id="line-10-27"></span>             <span class="ID">Event</span>.<span class="ID">DELETED</span>:<span class="String" style="color: rgb(0, 64, 128);">'</span><span class="String" style="color: rgb(0, 64, 128);">Deleted</span><span class="String" style="color: rgb(0, 64, 128);">'</span>,</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_11"></span><span class="anchor" id="line-11-24"></span>             <span class="ID">Event</span>.<span class="ID">UPDATED</span>:<span class="String" style="color: rgb(0, 64, 128);">'</span><span class="String" style="color: rgb(0, 64, 128);">Updated</span><span class="String" style="color: rgb(0, 64, 128);">'</span>,</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_12"></span><span class="anchor" id="line-12-23"></span>             <span class="ID">Event</span>.<span class="ID">CUSTOM_FIELD_UPDATED</span>:<span class="String" style="color: rgb(0, 64, 128);">'</span><span class="String" style="color: rgb(0, 64, 128);">Custom field updated</span><span class="String" style="color: rgb(0, 64, 128);">'</span>,</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_13"></span><span class="anchor" id="line-13-20"></span>             <span class="ID">Event</span>.<span class="ID">COMPLIANCE_UPDATED</span>:<span class="String" style="color: rgb(0, 64, 128);">'</span><span class="String" style="color: rgb(0, 64, 128);">Compliance Updated</span><span class="String" style="color: rgb(0, 64, 128);">'</span>,</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_14"></span><span class="anchor" id="line-14-20"></span>             <span class="ID">Event</span>.<span class="ID">COMPLIANCE_RECURRING_JOB_SCHEDULED</span>:<span class="String" style="color: rgb(0, 64, 128);">'</span><span class="String" style="color: rgb(0, 64, 128);">Compliance Recurring job scheduled</span><span class="String" style="color: rgb(0, 64, 128);">'</span>,</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_15"></span><span class="anchor" id="line-15-18"></span>             <span class="ID">Event</span>.<span class="ID">COMPLIANCE_SCHEDULE_CANCELED</span>:<span class="String" style="color: rgb(0, 64, 128);">'</span><span class="String" style="color: rgb(0, 64, 128);">Compliance schedule canceled</span><span class="String" style="color: rgb(0, 64, 128);">'</span>}</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_16"></span><span class="anchor" id="line-16-17"></span></span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_17"></span><span class="anchor" id="line-17-16"></span><span class="ID">lastEventPoll</span> = <span class="ResWord" style="color: rgb(160, 0, 0);">long</span>(<span class="ID">time</span>.<span class="ID">time</span>())</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_18"></span><span class="anchor" id="line-18-16"></span><span class="ResWord" style="color: rgb(160, 0, 0);">while</span> <span class="ResWord" style="color: rgb(160, 0, 0);">True</span>:</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_19"></span><span class="anchor" id="line-19-14"></span>    <span class="ID">events</span> = <span class="ID">ts</span>.<span class="ID">cache</span>.<span class="ID">EventCacheService</span>.<span class="ID">getEvents</span>(<span class="ID">lastEventPoll</span>)</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_20"></span><span class="anchor" id="line-20-14"></span>    <span class="ResWord" style="color: rgb(160, 0, 0);">for</span> <span class="ID">e</span> <span class="ResWord" style="color: rgb(160, 0, 0);">in</span> <span class="ID">events</span>.<span class="ID">getEvents</span>():</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_21"></span><span class="anchor" id="line-21-12"></span>        <span class="ResWord" style="color: rgb(160, 0, 0);">print</span> <span class="String" style="color: rgb(0, 64, 128);">"</span><span class="String" style="color: rgb(0, 64, 128);">%s</span><span class="String" style="color: rgb(0, 64, 128);"> </span><span class="String" style="color: rgb(0, 64, 128);">%s</span><span class="String" style="color: rgb(0, 64, 128);"> </span><span class="String" style="color: rgb(0, 64, 128);">%s</span><span class="String" style="color: rgb(0, 64, 128);">"</span> % (<span class="ID">time</span>.<span class="ID">ctime</span>(<span class="ID">e</span>.<span class="ID">date</span>), <span class="ID">e</span>.<span class="ID">source</span>, <span class="ID">actionMap</span>[<span class="ID">e</span>.<span class="ID">action</span>])</span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_22"></span><span class="anchor" id="line-22-10"></span>    <span class="ID">lastEventPoll</span> = <span class="ID">events</span>.<span class="ID">fetchDate</span></span>
<span class="line"><span class="LineAnchor" id="CA-859e22f195d669895507a4df15e402fa86e1c34d_23"></span><span class="anchor" id="line-23-10"></span>    <span class="ID">time</span>.<span class="ID">sleep</span>(<span class="Number" style="color: rgb(0, 128, 192);">10</span>) <span class="Comment" style="color: rgb(0, 128, 0);"># 10 seconds</span></span>
</pre></div></div><span class="anchor" id="line-1266" style="color: rgb(0, 0, 0); font-family: sans-serif;"></span><p class="line874" style="color: rgb(0, 0, 0); letter-spacing: normal; font-family: sans-serif; font-size: 16px;">Execution<span class="anchor" id="line-1267"></span><span class="anchor" id="line-1268"></span><span class="anchor" id="line-1269"></span><span class="anchor" id="line-1270"></span><span class="anchor" id="line-1271"></span><span class="anchor" id="line-1272"></span><span class="anchor" id="line-1273"></span></p><pre style="color: rgb(0, 0, 0); border-width: 1pt; border-style: solid; border-color: rgb(174, 189, 204); background-color: rgb(243, 245, 247); padding: 5pt; font-family: courier, monospace; white-space: pre-wrap; overflow-wrap: break-word;"><span class="anchor" id="line-1-20"></span>[root@dc1 EventCacheService]# ./monitorEvents.py
<span class="anchor" id="line-2-18"></span>Fri Oct  4 17:29:33 2019 (JobRef:114260001) Updated
<span class="anchor" id="line-3-12"></span>Fri Oct  4 17:29:45 2019 (JobRef:114270001) Updated
<span class="anchor" id="line-4-9"></span>Fri Oct  4 17:29:55 2019 (ServerRef:91190001) Compliance Updated
<span class="anchor" id="line-5-7"></span>Fri Oct  4 17:29:56 2019 (JobRef:114280001) Updated</pre><span class="anchor" id="line-1274" style="color: rgb(0, 0, 0); font-family: sans-serif;"></span><span class="anchor" id="line-1275" style="color: rgb(0, 0, 0); font-family: sans-serif;"></span><p class="line867" style="color: rgb(0, 0, 0); letter-spacing: normal; font-family: sans-serif; font-size: 16px;"></p><h2 id="Running_an_adHoc_script_synchronously_and_obtaining_results_.28redux.29" style="color: rgb(0, 0, 0); letter-spacing: normal; text-transform: none; font-family: sans-serif;">Running an adHoc script synchronously and obtaining results (redux)</h2><span class="anchor" id="line-1276" style="color: rgb(0, 0, 0); font-family: sans-serif;"></span><span class="anchor" id="line-1277" style="color: rgb(0, 0, 0); font-family: sans-serif;"></span><p class="line862" style="color: rgb(0, 0, 0); letter-spacing: normal; font-family: sans-serif; font-size: 16px;">To address the scalability issue raised while waiting for a job to finish we can make use of the Event service to reduce the number of times the call&nbsp;<tt class="backtick"></tt><tt class="backtick">getJobInfoVO</tt><tt class="backtick"></tt>&nbsp;is made. The event service is lightweight and designed to be polled the&nbsp;<tt class="backtick"></tt><tt class="backtick">getJobInfoVO</tt><tt class="backtick"></tt>&nbsp;call is not.<span class="anchor" id="line-1278"></span><span class="anchor" id="line-1279"></span></p><p class="line862" style="color: rgb(0, 0, 0); letter-spacing: normal; font-family: sans-serif; font-size: 16px;">Rather than constantly polling the job to check its state we now monitor with the&nbsp;<tt class="backtick"></tt><tt class="backtick">EventCacheService</tt><tt class="backtick"></tt>&nbsp;and when it tells us a change on the&nbsp;<tt class="backtick"></tt><tt class="backtick">jobRef</tt><tt class="backtick"></tt>&nbsp;has occurred only then do we check its state.<span class="anchor" id="line-1280"></span><span class="anchor" id="line-1281"></span></p><p class="line862" style="color: rgb(0, 0, 0); letter-spacing: normal; font-family: sans-serif; font-size: 16px;">We require a modification of the&nbsp;<tt class="backtick"></tt><tt class="backtick">waitForJobToFinish</tt><tt class="backtick"></tt>&nbsp;function in the previous example.<span class="anchor" id="line-1282"></span><span class="anchor" id="line-1283"></span><span class="anchor" id="line-1284"></span><span class="anchor" id="line-1285"></span><span class="anchor" id="line-1286"></span><span class="anchor" id="line-1287"></span><span class="anchor" id="line-1288"></span><span class="anchor" id="line-1289"></span><span class="anchor" id="line-1290"></span><span class="anchor" id="line-1291"></span><span class="anchor" id="line-1292"></span><span class="anchor" id="line-1293"></span><span class="anchor" id="line-1294"></span><span class="anchor" id="line-1295"></span><span class="anchor" id="line-1296"></span><span class="anchor" id="line-1297"></span><span class="anchor" id="line-1298"></span><span class="anchor" id="line-1299"></span><span class="anchor" id="line-1300"></span><span class="anchor" id="line-1301"></span><span class="anchor" id="line-1302"></span><span class="anchor" id="line-1-167"></span></p><div class="highlight python" style="color: rgb(0, 0, 0); font-family: sans-serif;"><div class="codearea" dir="ltr" lang="en" style="margin: 0.5em 0px; padding: 0px; border: 1pt solid rgb(174, 189, 204); background-color: rgb(243, 245, 247);"><pre dir="ltr" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1" lang="en" style="border-width: initial; border-style: none; background-color: rgb(243, 245, 247); padding: 10pt; font-family: courier, monospace; white-space: pre-wrap; overflow-wrap: break-word;"><span class="line"><span class="ResWord" style="color: rgb(160, 0, 0);">def</span> <span class="ID">waitForJobEvent</span>(<span class="ID">jobRef</span>):</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_2"></span><span class="anchor" id="line-2-88"></span>    <span class="ResWord" style="color: rgb(160, 0, 0);">global</span> <span class="ID">lastEventPoll</span></span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_3"></span><span class="anchor" id="line-3-73"></span>    <span class="ResWord" style="color: rgb(160, 0, 0);">while</span> <span class="ResWord" style="color: rgb(160, 0, 0);">True</span>:</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_4"></span><span class="anchor" id="line-4-59"></span>        <span class="ID">events</span> = <span class="ID">ts</span>.<span class="ID">cache</span>.<span class="ID">EventCacheService</span>.<span class="ID">getEvents</span>(<span class="ID">lastEventPoll</span>)</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_5"></span><span class="anchor" id="line-5-55"></span>        <span class="ResWord" style="color: rgb(160, 0, 0);">for</span> <span class="ID">e</span> <span class="ResWord" style="color: rgb(160, 0, 0);">in</span> <span class="ID">events</span>.<span class="ID">getEvents</span>():</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_6"></span><span class="anchor" id="line-6-47"></span>            <span class="ResWord" style="color: rgb(160, 0, 0);">if</span> <span class="ID">e</span>.<span class="ID">source</span> == <span class="ID">jobRef</span>:</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_7"></span><span class="anchor" id="line-7-39"></span>                <span class="ResWord" style="color: rgb(160, 0, 0);">return</span></span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_8"></span><span class="anchor" id="line-8-36"></span>            <span class="ID">lastEventPoll</span> = <span class="ID">events</span>.<span class="ID">fetchDate</span></span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_9"></span><span class="anchor" id="line-9-31"></span>            <span class="ID">time</span>.<span class="ID">sleep</span>(<span class="Number" style="color: rgb(0, 128, 192);">5</span>)</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_10"></span><span class="anchor" id="line-10-28"></span></span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_11"></span><span class="anchor" id="line-11-25"></span><span class="ResWord" style="color: rgb(160, 0, 0);">def</span> <span class="ID">waitForJobToFinish</span>(<span class="ID">jobRef</span>):</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_12"></span><span class="anchor" id="line-12-24"></span>    <span class="ResWord" style="color: rgb(160, 0, 0);">global</span> <span class="ID">lastEventPoll</span></span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_13"></span><span class="anchor" id="line-13-21"></span>    <span class="ID">lastEventPoll</span> = <span class="ResWord" style="color: rgb(160, 0, 0);">long</span>(<span class="ID">time</span>.<span class="ID">time</span>())</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_14"></span><span class="anchor" id="line-14-21"></span>    <span class="ID">jobvo</span> = <span class="ID">JobService</span>.<span class="ID">getJobInfoVO</span>(<span class="ID">jobRef</span>)</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_15"></span><span class="anchor" id="line-15-19"></span>    <span class="ResWord" style="color: rgb(160, 0, 0);">while</span> <span class="ID">jobvo</span>.<span class="ID">status</span> <span class="ResWord" style="color: rgb(160, 0, 0);">in</span> (<span class="ID">JobInfoVO</span>.<span class="ID">STATUS_ACTIVE</span>,<span class="ID">JobInfoVO</span>.<span class="ID">STATUS_PENDING</span>):</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_16"></span><span class="anchor" id="line-16-18"></span>        <span class="ID">waitForJobEvent</span>(<span class="ID">jobRef</span>)</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_17"></span><span class="anchor" id="line-17-17"></span>        <span class="ID">jobvo</span> = <span class="ID">JobService</span>.<span class="ID">getJobInfoVO</span>(<span class="ID">jobRef</span>)</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_18"></span><span class="anchor" id="line-18-17"></span>    <span class="ResWord" style="color: rgb(160, 0, 0);">print</span> <span class="String" style="color: rgb(0, 64, 128);">"</span><span class="String" style="color: rgb(0, 64, 128);">End: </span><span class="String" style="color: rgb(0, 64, 128);">%s</span><span class="String" style="color: rgb(0, 64, 128);">"</span> % <span class="ID">time</span>.<span class="ID">ctime</span>(<span class="ID">jobvo</span>.<span class="ID">endDate</span>)</span>
<span class="line"><span class="LineAnchor" id="CA-48d9a39df117ee1cf17d281eab3b7cba1ea552b1_19"></span><span class="anchor" id="line-19-15"></span>    <span class="ResWord" style="color: rgb(160, 0, 0);">print</span> <span class="String" style="color: rgb(0, 64, 128);">"</span><span class="String" style="color: rgb(0, 64, 128);">Job status: </span><span class="String" style="color: rgb(0, 64, 128);">%s</span><span class="String" style="color: rgb(0, 64, 128);">"</span> % <span class="ID">jobStatus</span>[<span class="ID">jobvo</span>.<span class="ID">status</span>]</span>
</pre></div></div><span class="anchor" id="line-1303" style="color: rgb(0, 0, 0); font-family: sans-serif;"></span><p class="line874" style="color: rgb(0, 0, 0); letter-spacing: normal; font-family: sans-serif; font-size: 16px;">This logic is not thread safe as we are using a global to track the last poll timestamp. Refactor into a class if multi-threading.</p>