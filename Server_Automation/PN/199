<p>Jobs represent actions in SA that run in the background and have progress and results.</p>

<p>You cannot access job information using core authentication. That is you must make an&nbsp;<tt>authenticate(user,pass)</tt>&nbsp;call.</p>

<p>&nbsp;</p>

<h2>Canceling a scheduled job</h2>

<p>The call is a single line but there is a lot of error handling that has to happen. You must authenticate as a user to perform any job manipulation using Core Authentication will not give you access.</p>

<pre>#!/opt/opsware/bin/python
import sys
from pytwist import twistserver
from pytwist.com.opsware.job import ScheduledJobRef, JobNotScheduledException
from pytwist.com.opsware.common import NotFoundException
from pytwist.com.opsware.fido import AuthorizationDeniedException

if len(sys.argv) &lt; 2:
    print "cancelScheduleJob &lt;id&gt; [reason]"
    sys.exit(1)

ts = twistserver.TwistServer()
ts.authenticate("user","password")
jobRef = ScheduledJobRef(long(sys.argv[1]))
reason = None if len(sys.argv) == 2 else sys.argv[2]
try:
    ts.job.JobService.cancelScheduledJob(jobRef, reason)
    print "Job schedule canceled"
except NotFoundException:
    print "Job not found"
except AuthorizationDeniedException:
    print "Unauthorized"
except JobNotScheduledException:
    print "Job not scheduled"
</pre>

<p>&nbsp;</p>

<h2>Start a scheduled job now</h2>

<p>There is a recurring job that is scheduled to run on Sunday but we want to run an instance of that job now and then let the recurring job continue to run on its normal schedule.</p>

<p>We run aground trying to implement this feature as the Twist search filters provides no mechanism to locate the children of a parent job. This filter won't work and its what we want to do.</p>

<pre>childJob = ts.search.SearchService.findObjRefs('(job_parent_id = xxxx) &amp; (job_status = PENDING)','job')
</pre>

<p>A small sojourn into the SA job scheduling system is required to understand the problem. When you create a recurring job SA actually creates two jobs.</p>

<table cellspacing="0" style="border-collapse:collapse">
	<tbody>
		<tr>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p><strong>Job Id</strong></p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p><strong>Status</strong></p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p><strong>Visibility</strong></p>
			</td>
		</tr>
		<tr>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>114680001</p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>RECURRING</p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>Visible</p>
			</td>
		</tr>
		<tr>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>114690001</p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>PENDING</p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>Hidden</p>
			</td>
		</tr>
	</tbody>
</table>

<p>These jobs are associated with each other by use of the&nbsp;<tt>parent_session_id</tt>&nbsp;column in the&nbsp;<tt>sessions</tt>&nbsp;database table. The PENDING child is what will be executed by the&nbsp;<strong>Way</strong>&nbsp;when its scheduled execution time becomes current. Upon completion of that child it will be marked as SUCCESS (or FAILURE) and a new PENDING child will be scheduled according to the scheduling rules held on the parent (RECURRING) job.</p>

<table cellspacing="0" style="border-collapse:collapse">
	<tbody>
		<tr>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p><strong>Job Id</strong></p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p><strong>Status</strong></p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p><strong>Visibility</strong></p>
			</td>
		</tr>
		<tr>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>114680001</p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>RECURRING</p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>Visible</p>
			</td>
		</tr>
		<tr>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>114690001</p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>SUCCESS</p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>Visible</p>
			</td>
		</tr>
		<tr>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>114700001</p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>PENDING</p>
			</td>
			<td style="border-color:#adb9cc; border-style:solid; border-width:1pt">
			<p>Hidden</p>
			</td>
		</tr>
	</tbody>
</table>

<p>If we want the PENDING child to run now we need to first find it and that is the crux of the issue. There is no Twist API call to do that. We workaround that problem by obtaining this information using the&nbsp;<strong>Spin</strong>&nbsp;in a read-only context.</p>

<pre>#!/opt/opsware/bin/python2
# Start a recurring job now
import sys, time
from pytwist import twistserver
from pytwist.com.opsware.job import ScheduledJobRef, JobInfoVO, JobSchedule, JobRef
from pytwist.com.opsware.common import NotFoundException
from coglib import spinwrapper

def start_pending(jobId):
    vo = ts.job.JobService.getJobInfoVO( JobRef( jobId ) )
    if vo.status != JobInfoVO.STATUS_RECURRING:
        print "This is not a scheduled job"
        sys.exit(1)

    # There is no TWIST filter to find a pending child of a recurring job !?
    spin = spinwrapper.SpinWrapper()
    childJob = spin.Session.getAll(restrict={'parent_session_id': jobId,
                                             'status':'PENDING'})[0]

    jobRef = ScheduledJobRef(childJob['id'])
    print "Found child job %s" % jobRef
    vo = ts.job.JobService.getJobInfoVO( jobRef )
    print "Scheduled to run at %s" % time.ctime(vo.schedule.startDate)
    sched = JobSchedule()
    sched.startDate = long(time.time() + 60)
    print "Rescheduled to run at %s" % time.ctime(sched.startDate)
    ts.job.JobService.updateScheduledJob( jobRef, vo.userTag, vo.notification, sched )


if len(sys.argv) != 2:
   print "startJobNow &lt;id&gt;"
   sys.exit(1)

ts = twistserver.TwistServer()
ts.authenticate('user','password')
try:
    start_pending(sys.argv[1])
except NotFoundException:
    print "Job not found"
</pre>

<p>Execution</p>

<p><img src="./mediawiki/images/PN/Recurring-jobs.png"></p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<pre>[root@dc1 JobService]# ./startJobNow.py 114680001
Found child job (ScheduledJobRef:114740001)
Scheduled to run at Sun Oct 13 18:01:00 2019
Rescheduled to run at Tue Oct  8 19:33:19 2019</pre>

<p>The PENDING child was rescheduled and it has executed becoming visible in the Job Logs</p>

<p><img src="./mediawiki/images/PN/Recurring-job-child.png"></p>
