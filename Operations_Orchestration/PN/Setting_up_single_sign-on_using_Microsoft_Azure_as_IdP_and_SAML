<div><br></div><div>Micro Focus Operations Orchestration supports sign-on (SSO) logins through SAML 2.0.</div><div>One of the used SAML 2.0 Identity Provider (IdP) in production is the <b>Azure Active Directory.</b></div><div>With SAML single sign-on, Azure AD authenticates to the application by using the user's Azure AD account.</div><div><br></div><div><span style="background-color: transparent;">To configure SAML single sign-on for a non-gallery application without writing code,&nbsp;</span><br></div><div>you need to have a subscription or Azure AD Premium and the application must support SAML 2.0.&nbsp;</div><div>For more information about Azure AD versions, visit&nbsp;<a href="https://azure.microsoft.com/en-us/pricing/details/active-directory/" target="_blank" style="background-color: transparent;">Azure AD pricing.</a>&nbsp;</div><div><br></div><div>For more details, see the link from Microsoft regarding&nbsp;<a href="https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/configure-single-sign-on-non-gallery-applications" target="_blank" style="background-color: transparent;">configure SAML-basel single sign-on to non-gallery applications</a>.</div><div><br></div><div><font size="6">Prerequisites</font></div><div><br></div><div>You need to have the following components in order to use Azure AD to login into your OO Central instance:</div><div><ul><li>The OO Central registerted as an application into to Azure Portal. If the application hasn't been added to your Azure AD tenant, see&nbsp;<a href="https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/add-non-gallery-app" target="_blank">Add a non-gallery&nbsp;</a>app provided by Azure</li><li>A OO Central Instance with authentication enabled.</li></ul></div><div><br></div><div><font size="6">Step 1 - Trust the Identity Provider</font></div><div><br></div><div>First step is to import the public keys of the identity provider's certificates into the OO Central internal <b>key.store</b> file located at &lt;path_to_central&gt;/central/var/security.</div><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>1. Access the OO Central registered application from the Azure portal, and from the <b>Single Sign-on</b> page get the SAML Signing Certificate.</div></blockquote><div><br></div><div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><img src="./mediawiki/images/PN/91.PNG"><br></blockquote></div><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>2. Import them to the OO Central <b>key.store</b> using the following command:</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><i><b>&lt;path_to_java&gt;/bin/keytool -importcert -keystore key.store -alias &lt;your_custom_alias&gt; -file &lt;path_to_cer_file&gt;/&lt;certificate&gt;.cer</b></i></div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>3. Restart the OO Central instance.</div></blockquote><div><br></div><div><font size="6">Step 2 - Configure OO Central instance</font></div><div><br></div><div>After setting up Azure AD and downloading the certificates, you need to configure your OO Central to authenticate using SAML.</div><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>1. Access the OO Central from your browser, go to <b>System Configuration</b> and select the <b>SAML </b>from the <b>Security </b>page.</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>2. Enable the SAML option from the page, then add a new custom <b>Entity ID</b>&nbsp;in the Service Provider area, or keep the predefined <b>"ooentityid"</b></div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>3. Add the <b>IDP metadata URL</b> of the Azure AD. It can be taken from the Azure AD portal, from the<b> Single Sign-on</b> page and <b>SAML Signing Certificate</b> section.&nbsp;<span style="background-color: transparent;">It should look like this:&nbsp;</span></div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><i><b>https://login.microsoftonline.com/&lt;random_app_id&gt;/federationmetadata/2007-06/federationmetadata.xml?appid=&lt;random_app_id&gt;</b></i></div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><i>See the above screenshot for more details.</i></div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>4. Configure a new custom <b>User</b> <b>name </b>and <b>Group name attribute</b> or keep the predefined <b>"username"</b> and <b>"groups</b>" values.</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><i>Note: Those values will be mapped with the data comming from Azure AD</i></div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>5. If the user comming from Azure AD is part of more then one group and those groups are separated within the SAML response, you need to define the <b>Group name delimite</b>r in order to consider each on the groups individual.</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>6. In case OO Central cannot directly access the Azure AD, you need to configure a <b>Proxy host</b> and a <b>Port</b> to facilitate the communication between them.</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>7. Unfortunately the SAML users cannot be used to execute scheduled OO flows, so you need to configure an <b>Internal user</b> from your OO for scheduling tasks.</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>8. Save the configurations using the <b>Save</b> button from the buttom.</div></blockquote><div><br></div><div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><img src="./mediawiki/images/PN/92.PNG"><br></div></blockquote></div><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>9. Download the OO Central metadata which needs to be uploaded into the Azure AD, using the <b>Download metadata</b> button.</div></blockquote><div><b><i><br></i></b></div><div><b><i>Note: Before accessing the OO Central using the Azure AD users, make sure you have an internal admin user, for this.&nbsp;</i></b></div><div><b><i>If you get locked out, with no access via the identity provider, you can log into OO directly. To log in directly, go to http(s)/&lt;host&gt;:&lt;port&gt;/oo/login/direct.</i></b></div><div><br></div><div><font size="6">Step 3 - Link the OO Central with the Azure AD</font></div><div><br></div><div>At this point you should be ready to set up the Azure AD connection with your OO Central instance.</div><div><br></div><div>You need to add the basic SAML configuration into the Azure portal, either manual or by uploading the OO Central metadata from above. If you chose option 2,&nbsp;<span style="background-color: transparent;">Azure will the extract the values of the fields.&nbsp;</span></div><div><span style="background-color: transparent;">We suggest to use option 2.</span></div><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>1. From <b>Single Sign-On</b> page, click on <b>Upload metadata file</b> button which is located above <b>Basic SAML Configuration </b>section, and save the details after that.&nbsp;<span style="background-color: transparent;">If you already had a OO Central defined, the upload will overwrite the values.</span></div></blockquote><div><br></div><div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><img src="./mediawiki/images/PN/93.PNG"><br></div></blockquote></div><div><br></div><div><br></div><div><font size="6">Step 4 - Creating user attribute and claim rules</font></div><div><br></div><div>Once the basic configurations have been created, you can create the claim rules that will facilitate the correct communication between Azure AD and OO Central</div><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>1. Click on <b>Edit</b> button of the <b>Users Attribute &amp; Claims</b> section to create a new claim.&nbsp;</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><img src="./mediawiki/images/PN/94.PNG"><br></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>2. Then, from the User Attributes &amp; Claims screen, do the following:</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>a. Click on the <b>Add new claim</b></div></blockquote></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>b. On the <b>Name</b> field,&nbsp; type the <b>"username"</b>.&nbsp;</div></blockquote></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><i><b>Note</b>: This value should be same with the value of the <b>User name attribute</b> from OO Central configuration page.</i></div></blockquote></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>c. Let the <b>Namespace</b> field empty</div></blockquote></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>d. The <b>Source </b>should be <b>Attribute</b></div></blockquote></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>e. Then from the <b>Source Attribute</b>&nbsp;select the&nbsp;<span style="background-color: transparent;"><b>user.givenname</b>&nbsp;</span><span style="background-color: transparent;">from the dropdown. It will be assigned to the <b>User name attribute</b> defined in OO Central.</span></div></blockquote></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><br></div><div><img src="./mediawiki/images/PN/95.PNG"><br></div></blockquote></div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>f. Click <b>Save </b>to define the new rule.</div></blockquote></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>3. Add then a <b>group claim</b> , this time selecting <b>Add a group claim</b> option from the same <b>User Attributes &amp; Claims</b> screen</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>a. Click on the <b>Add a group claim</b></div></blockquote></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>b. From the <b>Group Claims</b> screen, select the<b>&nbsp;All groups</b>&nbsp;associated with the users to be returned in the claim.</div></blockquote></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>c. Select the <b>Group ID</b> selected under the <b>Source Attribute</b> dropdown</div></blockquote></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>d. Check the<b>&nbsp;Customize the name of the group claim</b>&nbsp;option</div></blockquote></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>e. Type the <b>"groups"</b> as the <b>Name (requried)</b> of the claim</div></blockquote></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><i>Note: This value should be same with the value of the G<b>roup name attribute</b> from OO Central configuration page.</i></div></blockquote></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>f. Let the <b>Namespace </b>field empty</div></blockquote></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><img src="./mediawiki/images/PN/96.PNG"><br></blockquote></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>g. Save the new created claim</div></blockquote></blockquote><div><br></div><div><font size="6">Step 5 - Adjusting the signing algorithm</font></div><div><br></div><div>The signing algorithm can be adjust for proper communication between the Azure AD and the OO Central.</div><div>To access these settings, click on edit button from the <b>SAML Signing Certificate</b> section.</div><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>1. Inside the config page, make sure <b>SHA-1</b> is specified as the <b>Signing Algorithm</b>. This is the default value that OO Central is using.</div><div><span style="background-color: transparent;">2. Check the <b>Sign SAML response and assertion</b> as the option from the <b>Signing Option</b> dropdown.</span></div></blockquote><div><br></div><div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><img src="./mediawiki/images/PN/97.PNG"><br></div></blockquote></div><div><i><b>Note</b>: Inside the OO Central instance, you can change the Secure Hash Algorithm by adding the following new propertie at the end of the "wrapper.java.additional" list of parameters. Make sure to use numbers that are unique. If the last number is 34 then you can use numbers starting with 35 like below. The value should be sha1, sha256 or sha512. You need to restart the OO Central service after yo do those modifications.</i></div><div><span style="white-space:pre"><i>		</i></span></div><div><i>e.g</i></div><div><i>#Extra settings to add Central</i></div><div><i>wrapper.java.additional.35=-Dsaml.rsa.algorithm=sha256</i></div><div><br></div><div><font size="6">Step 6 - Map the Azure AD Group ID with a OO Central Role</font></div><div><br></div><div><br></div><div>If you will follow the above steps, then need to map the <b>Group ID</b> of the Azure AD users you want to use into the OO Central, with the <b>OO Central Role</b> you want them to have it.</div><div><br></div><div><img src="./mediawiki/images/PN/98.PNG"><br></div><div><br></div><div><img src="./mediawiki/images/PN/99.PNG"><br></div><div><br></div><div><br></div><div><font size="6">Troubleshoting</font></div><div><br></div><div>If the configurations are not done correctly, the communication between OO Central and Azure AD through SAML can suffer.</div><div>In case of any problem, we suggest to set the SAML logs from OO Central to <b>DEBUG</b>, to be able to see exactly what is the route cause of the issue. You need to restart the OO Central service after yo do those modifications.</div><div>In order to do this, edit the <b>log4j.properties</b> file which is located under the<b> &lt;path_to_central&gt;/central/conf</b> path, and set to <b>DEBUG </b>the SAML paramers, like below:</div><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>#SAML</div></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>log4j.logger.org.springframework.security.saml=DEBUG</div></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>log4j.logger.org.opensaml=DEBUG</div></blockquote><div><br></div><div><b>Possible errors</b> that can occur in general.log file:</div><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>1. If Azure AD certificates were not added correctly into the OO Central's key.store, they expired or were changed, the below error can be noticed:</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>Caused by: org.opensaml.saml2.metadata.provider.FilterException: <b>Signature trust establishment failed for metadata entry</b></div></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><span style="white-space:pre">	</span>org.opensaml.saml2.metadata.provider.SignatureValidationFilter.verifySignature(SignatureValidationFilter.java:327)</div></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><span style="white-space:pre">	</span>org.opensaml.saml2.metadata.provider.SignatureValidationFilter.processEntityDescriptor(SignatureValidationFilter.java:178)</div></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><span style="white-space:pre">	</span>org.opensaml.saml2.metadata.provider.SignatureValidationFilter.doFilter(SignatureValidationFilter.java:156)</div></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><span style="white-space:pre">	</span>org.opensaml.saml2.metadata.provider.AbstractMetadataProvider.filterMetadata(AbstractMetadataProvider.java:493)</div></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><span style="white-space:pre">	</span>org.opensaml.saml2.metadata.provider.AbstractReloadingMetadataProvider.processNonExpiredMetadata(AbstractReloadingMetadataProvider.java:395)</div></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><span style="white-space:pre">	</span>... 12 more</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><b><i>Solution:</i></b></div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>Make sure the Azure AD certificate is valid and correctly added into the OO Central's key.store.</div></blockquote><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>Don't forget to restart the OO Central service after import.</div></blockquote><div><br></div><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>2. If the URL of the Azure AD metadata was not set correctly or the communication Azure AD and OO Central is interrupted, you will see the following error:</div><div><br></div><div>https-jsse-nio-8444-exec-2] (SAMLEntryPoint.java:160) DEBUG - <b>Error initializing entry point</b></div><div>org.opensaml.saml2.metadata.provider.MetadataProviderException: No IDP was configured, please update included metadata with at least one IDP</div><div><span style="white-space:pre">	</span>org.springframework.security.saml.metadata.MetadataManager.getDefaultIDP(MetadataManager.java:795)</div><div><span style="white-space:pre">	</span>org.springframework.security.saml.context.SAMLContextProviderImpl.populatePeerEntityId(SAMLContextProviderImpl.java:157)</div><div><span style="white-space:pre">	</span>org.springframework.security.saml.context.SAMLContextProviderImpl.getLocalAndPeerEntity(SAMLContextProviderImpl.java:127)</div><div><span style="white-space:pre">	</span>org.springframework.security.saml.SAMLEntryPoint.commence(SAMLEntryPoint.java:146)</div><div><span style="white-space:pre">	</span>org.springframework.security.saml.SAMLEntryPoint.doFilter(SAMLEntryPoint.java:107)</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><i><b>Solution:</b></i></div><div><br></div><div>Check once again if the URL of the Azure AD metadata is correct or make sure the communication between the OO Central and Azure AD is not intrerupted.</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>3. If attributes are not defined properly or if the Azure AD claims does not correspond with our best practices, you will notice the below error in the server.log file&nbsp;</div><div><br></div><div>https-jsse-nio-8444-exec-10] (IdmConfigurationInfoController.java:42)<b> ERROR - Access is denied</b></div><div>https-jsse-nio-8444-exec-5] (OOSamlUserDetailsService.java:108) WARN&nbsp; - Attribute "usernamee" does not have any value defined</div><div>https-jsse-nio-8444-exec-5] (AuthenticationListener.java:50) WARN&nbsp; - Username is not defined in the SAML context</div><div>https-jsse-nio-8444-exec-5] (AuthenticationListener.java:52) WARN&nbsp; - Failed to login user "null"</div><div><br></div><div><i><b>Solution:</b></i></div><div><br></div><div>Double check if the User and Group attribute from OO SAML Configuration page corresponds with the ones from the Azure AD.</div></blockquote><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>4. If OO Central server has internet access but cannot contact Azure AD, you will see the following error in the logs:</div><div><br></div><div>Caused by: org.opensaml.saml2.metadata.provider.MetadataProviderException: <b>Error retrieving metadata from https://login.microsoftonline.com/&lt;random_app_id&gt;/federationmetadata/2007-06/federationmetadata.xml?appid=&lt;random_app_id&gt;</b></div><div><span style="white-space:pre">	</span>org.opensaml.saml2.metadata.provider.HTTPMetadataProvider.fetchMetadata(HTTPMetadataProvider.java:274)</div><div><span style="white-space:pre">	</span>org.opensaml.saml2.metadata.provider.AbstractReloadingMetadataProvider.refresh(AbstractReloadingMetadataProvider.java:255)</div><div><span style="white-space:pre">	</span>... 10 more</div><div>Caused by: javax.net.ssl.SSLHandshakeException:<b> Received fatal alert: access_denied</b></div><div><span style="white-space:pre">	</span>sun.security.ssl.Alerts.getSSLException(Alerts.java:192)</div><div><span style="white-space:pre">	</span>sun.security.ssl.Alerts.getSSLException(Alerts.java:154)</div><div><span style="white-space:pre">	</span>sun.security.ssl.SSLSocketImpl.recvAlert(SSLSocketImpl.java:2020)</div><div><br></div><div><br></div><div><b><i>Solution:</i></b></div><div><br></div><div>Make sure you have a proxy configured into the OO Central OO SAML Configuration page.</div></blockquote>