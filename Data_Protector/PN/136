<div>Data Protector allows&nbsp;<span style="background-color: transparent;">online backups of its&nbsp;</span><span style="background-color: transparent;">Internal Database (IDB). The IDB consists of d</span><span style="background-color: transparent;">atabase files, archive logs, Detail Catalog Binary Files (DCBF) and configuration files. The Internal Database can be protected by full and/or incremental backups virtually at any given time. An easy to use GUI-driven restore of the PostgreSQL-based database (with point-in-time recovery using archive logs), DCBFs and configuration files can be done in a one-step process or individually depending on the level of corruption.&nbsp;</span><span style="background-color: transparent;">Missing or damaged configuration files or damaged DCBFs can be restored without bringing the Cell Manager down.</span></div><div><span style="background-color: transparent;"><br></span></div><div><span style="background-color: transparent;">Regular IDB backups should be created on a&nbsp;</span><span style="background-color: transparent;">daily or even more frequently basis to an reliable backup device that can be quickly configured and imported in case of disaster. Information on the lastet IDB backups can be found in the&nbsp;<i>media.log</i>&nbsp;(OmniDB&nbsp;</span><span style="background-color: transparent;">entries</span><span style="background-color: transparent;">) on the Cell Manager.</span></div><div><span style="background-color: transparent;"><br></span></div><div><img src="./mediawiki/images/PN/2020-01-14_21h50_57.png"><span style="background-color: transparent;"><br></span></div><div><span style="background-color: transparent;"><br></span></div><div><span style="background-color: transparent;">As soon as the IDB restore is complete, the Cell Manager is operational. Reconnect the GUI, since the IDB was switched to the restored instance. Verify Devices &amp; Media and Internal Database context in the GUI. </span><span style="background-color: transparent;">While the restore and recovery is simple a Clean up at a later time might be requested so that standard directories are used again.</span></div><div><br></div><div><b>Note: </b>The Clean up is disruptive to Data Protector since the services must be stopped and should be scheduled in a maintenance window. It is not a required operation after an IDB restore. The only purpose is to remove stale files and directories from file system and return the directory structure to normal. It can be done immediately or weeks after the restore. Creating an offline backup, filesystem snapshot or similar as a fallback.</div><h2>Linux Cell Manager</h2><div><span style="background-color: transparent;">On a Linux Cell Manager the Internal Database is located in <i>/var/opt/omni/server/db80</i>. In this example we will restore the database to <i>/var/opt/omni/server/db80_restore</i>.<i>&nbsp;</i>If you need to adjust the restore path also adjust the commands and configuration file changes accordingly.</span></div><h3><span style="background-color: transparent;">Stop the services and check restored directory structure</span></h3><div><pre>[root@linux ~]# <b>omnisv stop</b><br>Cell Server services successfully stopped.</pre><pre><br>[root@linux ~]# <b>ls -l /var/opt/omni/server</b><br>drwxr-xr-x 5 hpdp hpdp 4096 May 9 12:44 AppServer<br><b><font color="#ff0000">drwxr-xr-x 19 root sys 4096 May 10 10:52 db80<br>drwxrwxrwx 5 root root 4096 May 10 10:49 db80_restore</font></b><br>drwxr-xr-x 4 root sys 4096 Mar 17 18:21 export<br>drwxr-xr-x 4 root sys 4096 Mar 17 18:21 import<br>drwxr-xr-x 4 root sys 4096 May 10 10:48 log<br>drwxr-xr-x 2 root sys 4096 Mar 17 18:21 sessions</pre><pre><br>[root@linux ~]# <b>ls -l /var/opt/omni/server/db80_restore</b><br>drwx------ 3 hpdp hpdp 4096 May 10 10:49 idb<br>drwx------ 3 hpdp hpdp 4096 May 10 10:49 jce<br>drwx------ 15 hpdp hpdp 4096 May 10 10:56 pg</pre></div><h3>Move the restored database to the target directory and adjust symlinks</h3><div><span style="background-color: transparent;">The name of the symlinks might be different on your Cell Manager.</span><br></div><div><span style="background-color: transparent;"><br></span></div><div><span style="background-color: transparent;"><pre>[root@linux ~]# <b>rm -rf /var/opt/omni/server/db80/idb</b><br>[root@linux ~]# <b>rm -rf /var/opt/omni/server/db80/jce</b><br>[root@linux ~]# <b>rm -rf /var/opt/omni/server/db80/pg</b><br>[root@linux ~]# <b>mv /var/opt/omni/server/db80_restore/* /var/opt/omni/server/db80/</b></pre><pre><br>[root@linux ~]# <b>ls -l /var/opt/omni/server/db80/pg/pg_tblspc</b><br>lrwxrwxrwx 1 hpdp hpdp 37 May 10 10:49 <b><font color="#ff0000">16387 -&gt; /var/opt/omni/server/db80_restore/idb</font></b><br>lrwxrwxrwx 1 hpdp hpdp 37 May 10 10:49 <b><font color="#ff0000">16445 -&gt; /var/opt/omni/server/db80_restore/jce</font></b></pre><pre><br>[root@linux ~]# <b>ln -sf /var/opt/omni/server/db80/idb /var/opt/omni/server/db80/pg/pg_tblspc/16387</b><br>[root@linux ~]# <b>ln -sf /var/opt/omni/server/db80/jce /var/opt/omni/server/db80/pg/pg_tblspc/16445</b></pre></span></div><h3>Update Configuration Files</h3><p>More complex changes should be done using a text editor such as vi.</p><div><span style="background-color: transparent;"><br></span></div><div><span style="background-color: transparent;"><pre>[root@linux ~]# <b>perl -p -i -e 's/db80_restore/db80/g' /var/opt/omni/server/db80/pg/postgresql.conf</b><br>[root@linux ~]# <b>perl -p -i -e 's/db80_restore/db80/g' /var/opt/omni/server/db80/pg/postmaster.opts</b><br>[root@linux ~]# <b>perl -p -i -e 's/db80_restore/db80/g' /etc/opt/omni/server/idb/idb.config</b><br>[root@linux ~]# <b>perl -p -i -e 's/db80_restore/db80/g' /etc/init.d/hpdp-idb</b></pre></span></div><h3>Additional Clean up</h3><div>This may or may not apply to your configuration.</div><div><div><br></div><pre>[root@linux ~]# <b>rm -rf /var/opt/omni/server/db80_restore</b><br>[root@linux ~]# <b>rm -rf /var/opt/omni/server/db80/msg_*</b><br>[root@linux ~]# <b>rm -rf /var/opt/omni/server/db80/meta_*</b><br>[root@linux ~]# <b>rm -rf /var/opt/omni/server/log/auditing_*</b></pre></div><h3>Start the services and do basic verification</h3><div>This also updates the references to the table spaces before starting the remaining services.<br></div><div><br></div><div><pre>[root@linux ~]# <b>omnisv start -idb_only</b><br>The Internal database services successfully started.</pre><pre><br>[root@linux ~]# <b>omnisv status</b><br>&nbsp; &nbsp; ProcName&nbsp; &nbsp; &nbsp; Status&nbsp; [PID]<br>===============================<br>&nbsp; &nbsp; crs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: Down<br>&nbsp; &nbsp; mmd&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: Down<br>&nbsp; &nbsp; kms&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: Down<br>&nbsp; &nbsp; hpdp-idb&nbsp; &nbsp; : Active&nbsp; [31686]<br>&nbsp; &nbsp; hpdp-idb-cp : Active&nbsp; [31707]<br>&nbsp; &nbsp; hpdp-as&nbsp; &nbsp; &nbsp;: Down<br>&nbsp; &nbsp; omnitrig&nbsp; &nbsp; : Down<br>&nbsp; &nbsp; Sending of traps disabled.<br>===============================<br>Status: At least one of the Cell Server processes/services is not running.</pre><pre><br>[root@linux ~]# <b>grep PGSUPERUSER /etc/opt/omni/server/idb/idb.config</b><br>PGSUPERUSER='<b><font color="#ff0000">hpdp</font></b>';<br>[root@linux ~]# <b>grep PGPORT /etc/opt/omni/server/idb/idb.config</b><br>PGPORT='<b><font color="#ff0000">7112</font></b>';</pre><pre><br>[root@linux ~]# <b>su - hpdp</b><br>[hpdp@linux ~]$ <b>/opt/omni/idb/bin/psql -U hpdp -h /var/opt/omni/tmp -p 7112 postgres</b></pre><pre><b><br></b>postgres=# <b>SELECT spcname, spclocation FROM pg_tablespace;</b><br>&nbsp; spcname&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; spclocation<br>------------+-------------------------------<br>&nbsp;pg_default |<br>&nbsp;pg_global&nbsp; |<br><font color="#ff0000"><b style="">&nbsp;hpdpidb&nbsp; &nbsp; | /var/opt/omni/server/db80_restore/idb</b><br><b style="">&nbsp;hpjce&nbsp; &nbsp; &nbsp; | /var/opt/omni/server/db80_restore/jce</b></font><br>(4 rows)</pre><pre><br>postgres=# <b>UPDATE pg_tablespace SET spclocation = '/var/opt/omni/server/db80/idb' where spcname='hpdpidb';</b><br>UPDATE 1<br>postgres=# <b>UPDATE pg_tablespace SET spclocation = '/var/opt/omni/server/db80/jce' where spcname='hpjce';</b><br>UPDATE 1</pre><pre><br>postgres=# <b>\q</b><br>[hpdp@linux ~]$ <b>exit</b></pre><pre><b><br></b>[root@linux ~]# <b>omnisv start</b><br>Cell Server services successfully started.</pre><pre><br>[root@linux ~]# <b>omnidbcheck -extended</b><br>Check Level&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Mode&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Status<br>===========================================================<br>Database connection&nbsp; &nbsp; &nbsp;-connection&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OK<br>Schema consistency&nbsp; &nbsp; &nbsp; -schema_consistency&nbsp; &nbsp; &nbsp;OK<br>Datafiles consistency&nbsp; &nbsp;-verify_db_files&nbsp; &nbsp; &nbsp; &nbsp; OK<br>Database consistency&nbsp; &nbsp; -database_consistency&nbsp; &nbsp;OK<br>Media consistency&nbsp; &nbsp; &nbsp; &nbsp;-media_consistency&nbsp; &nbsp; &nbsp; OK<br>SIBF(readability)&nbsp; &nbsp; &nbsp; &nbsp;-sibf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OK<br>DCBF(presence and size) -bf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OK<br>OMNIDC(consistency)&nbsp; &nbsp; &nbsp;-dc&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OK<br>DONE!</pre><pre><br>[root@linux ~]# <b>omnib -idb_list LINUX_IDB -barmode full</b><br><br>[Normal] From: BSM@linux.domain.tld "LINUX_IDB" Time: 05/10/2014 12:44:16 PM<br>OB2BAR application on "linux.domain.tld" successfully started.</pre><pre><br>[Normal] From: OB2BAR_POSTGRES_BAR@linux.domain.tld "DPIDB" Time: 05/10/2014 12:44:16 PM<br>Checking the Internal Database consistency</pre><pre><br>[Normal] From: OB2BAR_POSTGRES_BAR@linux.domain.tld "DPIDB" Time: 05/10/2014 12:44:17 PM<br>Check of the Internal Database consistency succeeded</pre><pre><br>[Normal] From: OB2BAR_POSTGRES_BAR@linux.domain.tld "DPIDB" Time: 05/10/2014 12:44:17 PM<br>Putting the Internal database into the backup mode finished</pre></div><div><h2 style="font-family: MetricHPE; text-transform: none; color: rgb(0, 0, 0);">Windows Cell Manager</h2><div><span style="background-color: transparent;">On a Windows Cell Manager the default&nbsp;</span><span style="background-color: transparent;">installation paths are <i>C:\Program Files\OmniBack </i>and <i>C:\ProgramData\OmniBack</i>. In this example&nbsp;</span><span style="background-color: transparent;">Data Protector is installed completely to <i>O:\OmniBack</i>. The IDB was stored in&nbsp;</span><span style="background-color: transparent;"><i>O:\OmniBack\server\db80</i></span><span style="background-color: transparent;">&nbsp;and the restore was done to&nbsp;</span><span style="background-color: transparent;"><i>O:\OmniBack\server\db80_restore</i></span><span style="background-color: transparent;">. Please&nbsp;</span><span style="background-color: transparent;">adjust the original path and the restore path, commands and configuration file changes accordingly.</span></div><h3 style="color: rgb(0, 0, 0); font-family: MetricHPE; text-transform: none;"><span style="background-color: transparent; letter-spacing: 1.1px;">Stop the services and check restored directory structure</span></h3></div><div><div><pre>O:\&gt;<b>omnisv stop</b>
Cell Server services successfully stopped.

O:\&gt;<b>dir O:\OmniBack\server</b>
Volume in drive O is OmniBack
Volume Serial Number is 261B-48D4

Directory of O:\OmniBack\server

07/02/2015 10:36 AM &lt;DIR&gt; .
07/02/2015 10:36 AM &lt;DIR&gt; ..
06/15/2015 04:46 PM &lt;DIR&gt; AppServer
<b><font color="#ff0000">07/02/2015 10:40 AM &lt;DIR&gt; db80
07/02/2015 10:37 AM &lt;DIR&gt; db80_restore</font></b>
0 File(s) 0 bytes
5 Dir(s) 86,840,508,416 bytes free

O:\&gt;<b>dir O:\OmniBack\server\db80</b>
Volume in drive O is OmniBack
Volume Serial Number is 261B-48D4

Directory of O:\OmniBack\server\db80

07/02/2015 10:40 AM &lt;DIR&gt; .
07/02/2015 10:40 AM &lt;DIR&gt; ..
06/15/2015 04:47 PM &lt;DIR&gt; dcbf
07/01/2015 08:46 PM &lt;DIR&gt; idb
07/01/2015 08:46 PM &lt;DIR&gt; jce
06/15/2015 09:38 PM &lt;DIR&gt; keystore
06/15/2015 04:46 PM &lt;DIR&gt; logfiles
<b><font color="#ff0000">06/15/2015 04:46 PM &lt;DIR&gt; meta
07/02/2015 10:36 AM &lt;DIR&gt; meta_2015_07_02-4_1435826212</font></b>
07/02/2015 10:40 AM 13,276 mmd.ctx
06/15/2015 05:08 PM 16 mmd.id
<b><font color="#ff0000">06/15/2015 08:18 PM &lt;DIR&gt; msg
07/02/2015 10:36 AM &lt;DIR&gt; msg_2015_07_02-4_1435826212</font></b>
07/02/2015 10:39 AM &lt;DIR&gt; pg
06/15/2015 04:46 PM &lt;DIR&gt; reportdb
06/15/2015 04:46 PM &lt;DIR&gt; smisdb
06/15/2015 04:46 PM &lt;DIR&gt; sqldb
06/15/2015 04:46 PM &lt;DIR&gt; sysdb
06/15/2015 04:46 PM &lt;DIR&gt; vssdb
06/15/2015 04:46 PM &lt;DIR&gt; xpdb
2 File(s) 13,292 bytes
18 Dir(s) 86,840,508,416 bytes free

O:\&gt;<b>dir O:\OmniBack\server\db80_restore</b>
Volume in drive O is OmniBack
Volume Serial Number is 261B-48D4

Directory of O:\OmniBack\server\db80_restore

07/02/2015 10:37 AM &lt;DIR&gt; .
07/02/2015 10:37 AM &lt;DIR&gt; ..
07/02/2015 10:37 AM &lt;DIR&gt; idb
07/02/2015 10:37 AM &lt;DIR&gt; jce
07/02/2015 10:43 AM &lt;DIR&gt; pg
0 File(s) 0 bytes
5 Dir(s) 86,840,508,416 bytes free</pre></div><h3 style="color: rgb(0, 0, 0); font-family: MetricHPE; text-transform: none;"><span style="color: inherit; font-family: inherit; letter-spacing: 1.1px; text-transform: initial; background-color: transparent;">Move the restored database to the target directory and adjust directory junctions</span></h3><div><span style="background-color: transparent;">The name of the directory junctions might be different on your Cell Manager.</span><br></div><div><span style="background-color: transparent;"><br></span></div><div><span style="background-color: transparent;"><pre>O:\&gt;<b>rmdir /S /Q O:\OmniBack\server\db80\idb</b>
O:\&gt;<b>rmdir /S /Q O:\OmniBack\server\db80\jce</b>
O:\&gt;<b>rmdir /S /Q O:\OmniBack\server\db80\pg</b>

O:\&gt;<b>move /Y O:\OmniBack\server\db80_restore\idb O:\OmniBack\server\db80</b>
O:\&gt;<b>move /Y O:\OmniBack\server\db80_restore\jce O:\OmniBack\server\db80</b>
O:\&gt;<b>move /Y O:\OmniBack\server\db80_restore\pg O:\OmniBack\server\db80</b>

O:\&gt;<b>dir O:\OmniBack\server\db80\pg\pg_tblspc</b>
Volume in drive O is OmniBack
Volume Serial Number is 261B-48D4

Directory of O:\OmniBack\server\db80\pg\pg_tblspc

07/02/2015 10:37 AM &lt;DIR&gt; .
07/02/2015 10:37 AM &lt;DIR&gt; ..
07/02/2015 10:37 AM <b><font color="#ff0000">&lt;JUNCTION&gt; 16387 [O:\OmniBack\server\db80_restore\idb]</font></b>
07/02/2015 10:37 AM <b style=""><font color="#ff0000">&lt;JUNCTION&gt; 16445 [O:\OmniBack\server\db80_restore\jce]</font></b>
0 File(s) 0 bytes
4 Dir(s) 87,235,559,424 bytes free

O:\&gt;<b>rmdir /Q O:\OmniBack\server\db80\pg\pg_tblspc\16387</b>
O:\&gt;<b>rmdir /Q O:\OmniBack\server\db80\pg\pg_tblspc\16445</b>

O:\&gt;<b>mklink /J O:\OmniBack\server\db80\pg\pg_tblspc\16387 O:\OmniBack\server\db80\idb</b>
Junction created for O:\OmniBack\server\db80\pg\pg_tblspc\16387 &lt;&lt;===&gt;&gt; O:\OmniBack\server\db80\idb

O:\&gt;<b>mklink /J O:\OmniBack\server\db80\pg\pg_tblspc\16445 O:\OmniBack\server\db80\jce</b>
Junction created for O:\OmniBack\server\db80\pg\pg_tblspc\16445 &lt;&lt;===&gt;&gt; O:\OmniBack\server\db80\jce</pre></span></div><h3 style="color: rgb(0, 0, 0); font-family: MetricHPE; text-transform: none;"><span style="color: inherit; font-family: inherit; letter-spacing: 1.1px; text-transform: initial; background-color: transparent;">Update Configuration Files&nbsp;</span></h3><div><span style="background-color: transparent;">For example replace all occurrences of <i>db80_restore</i><b> </b>with <i>db80</i>. While looking at the <i>idb.config </i>file take a note of the values <i>PGSUPERUSER </i>and <i>PGPORT </i>as we need them when using the <i>psql </i>command.</span></div><div><span style="background-color: transparent;"><br></span></div><div><span style="background-color: transparent;"><pre>O:\&gt;<b>notepad O:\OmniBack\server\db80\pg\postgresql.conf</b>
O:\&gt;<b>notepad O:\OmniBack\server\db80\pg\postmaster.opts</b>
O:\&gt;<b>notepad O:\OmniBack\Config\Server\idb\idb.config</b></pre></span></div><h3 style="color: rgb(0, 0, 0); font-family: MetricHPE; text-transform: none;">Changes to the Windows Registry</h3><div>Adjust the <i>ImagePath </i>registry value for the <i>hpdp-idb </i>service in <i>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\hpdp-idb </i>to reflect the previous changes<br></div><div><br></div><div><img src="./mediawiki/images/PN/2020-01-14_22h46_45.png"><br></div><h3 style="color: rgb(0, 0, 0); font-family: MetricHPE; text-transform: none;">Additional Clean up</h3><div>This may or may not apply to your configuration.</div><div><div><br></div><pre>O:\&gt;<b>rmdir /Q /S O:\OmniBack\server\db80_restore</b>
O:\&gt;<b>rmdir /Q /S O:\OmniBack\server\db80\meta_*</b>
O:\&gt;<b>rmdir /Q /S O:\OmniBack\server\db80\msg_*</b>
O:\&gt;<b>rmdir /Q /S O:\OmniBack\log\server\auditing_*</b></pre></div><h3 style="color: rgb(0, 0, 0); font-family: MetricHPE; text-transform: none;">Start the services and do basic verification</h3><div>This also updates the references to the table spaces before starting the remaining services.<br></div><div><br></div><div><pre>O:\&gt;<b>omnisv start -idb_only</b>
The Internal database services successfully started.

O:\&gt;<b>omnisv status</b>
    ProcName      Status  [PID]
===============================
    crs         : Down
    mmd         : Down
    kms         : Down
    hpdp-idb    : Active  [4136]
    hpdp-idb-cp : Active  [5528]
    hpdp-as     : Down
    omnitrig    : Down
    omniinet    : Down
    Sending of traps disabled
===============================
Status: At least one of the Cell Server processes/services is not running.

O:\&gt;<b>O:\OmniBack\idb\bin\psql.exe -U hpdp -h localhost -p 7112 postgres</b>

postgres=# <b>SELECT spcname, spclocation FROM pg_tablespace;</b>
  spcname   |         spclocation
------------+-----------------------------
 pg_default |
 pg_global  |
<b><font color="#ff0000"> hpdpidb    | O:/OmniBack/server/db80_restore/idb
 hpjce      | O:/OmniBack/server/db80_restore/jce</font></b>
(4 rows)

postgres=# <b>UPDATE pg_tablespace SET spclocation = 'O:/OmniBack/server/db80/idb' WHERE spcname = 'hpdpidb';</b>
UPDATE 1
postgres=# <b>UPDATE pg_tablespace SET spclocation = 'O:/OmniBack/server/db80/jce' WHERE spcname = 'hpjce';</b>
UPDATE 1

postgres=# <b>\q</b>

O:\&gt;<b>omnisv start</b>
Cell Server services successfully started.

O:\&gt;<b>omnidbcheck -extended</b>
Check Level             Mode                    Status
===========================================================
Database connection     -connection             OK
Schema consistency      -schema_consistency     OK
Datafiles consistency   -verify_db_files        OK
Database consistency    -database_consistency   OK
Media consistency       -media_consistency      OK
SIBF(readability)       -sibf                   OK
DCBF(presence and size) -bf                     OK
OMNIDC(consistency)     -dc                     OK
DONE!

O:\&gt;<b>omnib -idb_list WINDOWS_IDB</b>

[Normal] From: BSM@windows.domain.tld "WINDOWS_IDB" Time: 7/2/2015 11:15:17 AM
OB2BAR application on "windows.domain.tld" successfully started.

[Normal] From: OB2BAR_POSTGRES_BAR@windows.domain.tld "DPIDB" Time: 7/2/2015 11:15:18 AM
Checking the Internal Database consistency

[Normal] From: OB2BAR_POSTGRES_BAR@windows.domain.tld "DPIDB" Time: 7/2/2015 11:15:19 AM
Check of the Internal Database consistency succeeded

[Normal] From: OB2BAR_POSTGRES_BAR@windows.domain.tld "DPIDB" Time: 7/2/2015 11:15:19 AM
Putting the Internal database into the backup mode finished</pre></div></div><br>